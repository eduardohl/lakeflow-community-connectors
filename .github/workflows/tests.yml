name: Tests

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  # Detect which paths changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      libs: ${{ steps.check.outputs.libs }}
      pipeline: ${{ steps.check.outputs.pipeline }}
      example: ${{ steps.check.outputs.example }}
      community_connector: ${{ steps.check.outputs.community_connector }}
      sources: ${{ steps.check.outputs.sources }}
    steps:
      - uses: actions/checkout@v4
      # cannot use dorny because of ip allowlisting
      # - uses: dorny/paths-filter@v3
        with:
          fetch-depth: 0
      - name: Check changed paths
        id: check
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.event.after }}"
          fi

          # Handle initial commit or force push
          if ! git cat-file -e "$BASE_SHA" 2>/dev/null; then
            BASE_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          fi

          if [ -z "$BASE_SHA" ]; then
            # First commit, check all files
            CHANGED_FILES=$(git ls-files)
          else
            CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check libs
          if echo "$CHANGED_FILES" | grep -qE '^(src/databricks/labs/community_connector/libs/|tests/unit/libs/)'; then
            echo "libs=true" >> $GITHUB_OUTPUT
          else
            echo "libs=false" >> $GITHUB_OUTPUT
          fi

          # Check pipeline
          if echo "$CHANGED_FILES" | grep -qE '^(src/databricks/labs/community_connector/pipeline/|tests/unit/pipeline/)'; then
            echo "pipeline=true" >> $GITHUB_OUTPUT
          else
            echo "pipeline=false" >> $GITHUB_OUTPUT
          fi

          # Check example (also triggers on interface changes)
          if echo "$CHANGED_FILES" | grep -qE '^(src/databricks/labs/community_connector/sources/(example|interface)/|tests/unit/sources/(example/|test_suite\.py|test_utils\.py|lakeflow_connect_test_utils\.py))'; then
            echo "example=true" >> $GITHUB_OUTPUT
          else
            echo "example=false" >> $GITHUB_OUTPUT
          fi

          # Check tools/community_connector
          if echo "$CHANGED_FILES" | grep -q '^tools/community_connector/'; then
            echo "community_connector=true" >> $GITHUB_OUTPUT
          else
            echo "community_connector=false" >> $GITHUB_OUTPUT
          fi

          # Detect per-source connector changes
          # Triggers when source code, test code, or libs/utils.py changes
          UTILS_CHANGED=false
          if echo "$CHANGED_FILES" | grep -qE '^src/databricks/labs/community_connector/libs/utils\.py$'; then
            UTILS_CHANGED=true
          fi

          # Read exclude list into a temp file (skip comments and blank lines)
          EXCLUDE_FILE=".github/workflows/test_exclude.txt"
          EXCLUDES_TMP=$(mktemp)
          if [ -f "$EXCLUDE_FILE" ]; then
            grep -v '^\s*#' "$EXCLUDE_FILE" | grep -v '^\s*$' > "$EXCLUDES_TMP" || true
          fi

          # Find all source connector directories and check for changes
          CHANGED_SOURCES=""
          for source_dir in src/databricks/labs/community_connector/sources/*/; do
            source_name=$(basename "$source_dir")

            # Skip non-connector directories
            if [ "$source_name" = "interface" ] || [ "$source_name" = "__pycache__" ]; then
              continue
            fi

            # Check if this source's code, tests, or utils.py changed
            SOURCE_TRIGGERED=false
            if [ "$UTILS_CHANGED" = "true" ]; then
              SOURCE_TRIGGERED=true
            elif echo "$CHANGED_FILES" | grep -qE "^src/databricks/labs/community_connector/sources/${source_name}/"; then
              SOURCE_TRIGGERED=true
            elif echo "$CHANGED_FILES" | grep -qE "^tests/unit/sources/${source_name}/"; then
              SOURCE_TRIGGERED=true
            fi

            if [ "$SOURCE_TRIGGERED" = "true" ] && [ -d "tests/unit/sources/${source_name}" ]; then
              # Check if source has at least one non-excluded test file
              HAS_RUNNABLE_TESTS=false
              for test_file in tests/unit/sources/${source_name}/test_*.py; do
                if [ -f "$test_file" ] && ! grep -qxF "$test_file" "$EXCLUDES_TMP"; then
                  HAS_RUNNABLE_TESTS=true
                  break
                fi
              done

              if [ "$HAS_RUNNABLE_TESTS" = "true" ]; then
                CHANGED_SOURCES="${CHANGED_SOURCES:+$CHANGED_SOURCES,}\"${source_name}\""
                echo "Source to test: $source_name"
              else
                echo "Skipping $source_name (all tests excluded)"
              fi
            fi
          done

          rm -f "$EXCLUDES_TMP"
          echo "sources=[${CHANGED_SOURCES}]" >> $GITHUB_OUTPUT
          echo "Sources to test: [${CHANGED_SOURCES}]"

  # Test libs
  test-libs:
    needs: changes
    if: ${{ needs.changes.outputs.libs == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Run libs tests
        run: |
          pytest tests/unit/libs/ -v

  # Test pipeline
  test-pipeline:
    needs: changes
    if: ${{ needs.changes.outputs.pipeline == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Run pipeline tests
        run: |
          pytest tests/unit/pipeline/ -v

  # Test example source
  test-example:
    needs: changes
    if: ${{ needs.changes.outputs.example == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Run example tests
        run: |
          pytest tests/unit/sources/example/ -v

  # Test community connector tool
  test-community-connector:
    needs: changes
    if: ${{ needs.changes.outputs.community_connector == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          cd tools/community_connector
          pip install -e ".[dev]"
      - name: Run community connector tests
        run: |
          cd tools/community_connector
          pytest tests/ -v

  # Test source connectors (per-source, triggered by source/test/utils changes)
  test-source:
    needs: changes
    if: ${{ needs.changes.outputs.sources != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        source: ${{ fromJson(needs.changes.outputs.sources) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          # Install source-specific dependencies if the source has its own pyproject.toml
          SOURCE_DIR="src/databricks/labs/community_connector/sources/${{ matrix.source }}"
          if [ -f "$SOURCE_DIR/pyproject.toml" ]; then
            pip install -e "$SOURCE_DIR"
          fi
      - name: Run ${{ matrix.source }} tests
        run: |
          IGNORE_FLAGS=""
          EXCLUDE_FILE=".github/workflows/test_exclude.txt"
          if [ -f "$EXCLUDE_FILE" ]; then
            while IFS= read -r line; do
              # Skip comments and empty lines
              [[ "$line" =~ ^[[:space:]]*# ]] && continue
              [[ -z "${line// }" ]] && continue
              # Add --ignore for excluded tests in this source's directory
              if [[ "$line" == tests/unit/sources/${{ matrix.source }}/* ]]; then
                IGNORE_FLAGS="$IGNORE_FLAGS --ignore=$line"
              fi
            done < "$EXCLUDE_FILE"
          fi
          echo "Ignore flags: $IGNORE_FLAGS"
          pytest tests/unit/sources/${{ matrix.source }}/ $IGNORE_FLAGS -v
